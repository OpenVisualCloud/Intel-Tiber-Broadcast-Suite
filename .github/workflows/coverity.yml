name: Coverity scan

on:
  push:
  workflow_dispatch:

env:
  BUILD_TYPE: "Release"
  DOCKER_IMAGE_BASE: "ghcr.io/openvisualcloud/intel-tiber-broadcast-suite"
  DOCKER_IMAGE_NAME: "tiber-broadcast-suite-build"
  DOCKER_IMAGE_TAG: "${{ github.sha }}"
  DEBIAN_FRONTEND: "noninteractive"

jobs:
  build-stage-build:
    name: 'build BCS build stage'
    runs-on: ['self-hosted', 'Linux', 'cov']
    steps:
      - name: 'setup: checkout repo'
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
        
      - name: "Validation: Build/Push Dokcerfile"
        uses: docker/build-push-action@ca052bb54ab0790a636c9b5f226502c73d547a25 # v5.4.0
        with:
         file: Dockerfile
         push: false
         load: true
         target: build-stage
         cache-from: type=local,src=/tmp/.buildx-cache
         cache-to: type=local,dest=/tmp/.buildx-cache
         tags: "${{ env.DOCKER_IMAGE_BASE }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}"
         platforms: "linux/amd64"
      - name: install coverity in docker
        run: |
         docker run --rm -v $(pwd):/tmp/coverity\
          ${{ env.DOCKER_IMAGE_BASE }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}\
          /bin/bash -c "cd /tmp/coverity && .github/coverity/install-coverity.sh"