name: Coverity scan

on:
  push:
  workflow_dispatch:

env:
  BUILD_TYPE: "Release"
  DOCKER_IMAGE_BASE: "ghcr.io/openvisualcloud/intel-tiber-broadcast-suite"
  DOCKER_IMAGE_NAME: "tiber-broadcast-suite-build"
  DOCKER_IMAGE_TAG: "${{ github.sha }}"
  DEBIAN_FRONTEND: "noninteractive"

jobs:
  build-stage-build:
    name: 'build BCS build stage'
    runs-on: ['self-hosted', 'Linux', 'cov']
    steps:
      - name: 'setup: checkout repo'
        uses: actions/checkout@692973e3d937129bcbf40652eb9f2f61becf3332 # v4.1.7
      - name: build docker image
        run: |
          docker build --target build-stage\
          -t ${{ env.DOCKER_IMAGE_BASE }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }} . 

      - name: install coverity in docker
        run: |
         docker run --rm -v $(pwd):/tmp/coverity\
          ${{ env.DOCKER_IMAGE_BASE }}/${{ env.DOCKER_IMAGE_NAME }}:${{ env.DOCKER_IMAGE_TAG }}\
          /bin/bash -c "cd /tmp/coverity && .github/coverity/install-coverity.sh"